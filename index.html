<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>mmth.ca - Mastodon Share Service</title>
    <script>
        /* core script to handle protocol redirection for Mastodon URLs */
        function applyFormats(innerUrl, dialog, dialog_text, remainingFormats) {
            const description = remainingFormats.shift();
            window.location.href = formatUrl(innerUrl, description);

            // essentially serves as a debounce; if we get success, we won't be on this page anymore.
            setTimeout(() => {
                // this is necessary to ensure that the user has interacted with the page. This is required for Chrome.
                if(remainingFormats.length > 0) {
                    fake_alert(dialog, dialog_text, "Redirecting to the Mastodon app... " + remainingFormats.length + " protocols remaining.")
                        .then(() => {
                            applyFormats(innerUrl, dialog, dialog_text, remainingFormats);
                        })
                        .catch((msg) => {
                            alert(msg);
                            // if we have a failed future, the dialog was cancelled instead of accepted,
                            // so we want to immediately skip to HTTPS
                            applyFormats(innerUrl, dialog, dialog_text, ["https:"]);
                        });
                }
            }, 100);
        }

        function formatUrl(baseUrl, proto) {
            // if we got here, we're doing fallback to the base pattern
            return baseUrl.href.indexOf("://") === -1 ? baseUrl.href = proto + baseUrl.href : proto + baseUrl.href.substring(baseUrl.href.indexOf(":") + 1);
        }

        function fake_alert(dialog, target_text, text) {
            let promise = new Promise((resolve, reject) => {
                let evt = () => {
                    dialog.removeEventListener("close", evt);
                    if(dialog.returnValue === "cancel") {
                        reject("User cancelled the dialog.");
                    } else if(dialog.returnValue === "continue") {
                        resolve("User accepted the dialog.");
                    } else {
                        reject("Unexpected dialog return value: " + dialog.returnValue);
                    }
                };
                dialog.addEventListener("close", evt);
            });
            target_text.textContent = text;
            dialog.showModal();
            return promise;
        }

        /// Uses navigator.userAgent to determine if the user is on a mobile device.
        function isMobile() {
            const navUAData = navigator && navigator.userAgentData;
            if(navUAData) {
                return navUAData.mobile;
            } else {
                return /Android|gecko-trail|iPhone|iPad/i.test(navigator.userAgent);
            }
        }

        function addButtonListeners(dialog) {
            const buttons = dialog.querySelectorAll(".dialog-close-button");
            buttons.forEach(button => {
                button.addEventListener("click", (event) => {
                    event.preventDefault();
                    dialog.close(button.value);
                });
            });
        }

        /* wait until page load to start the redirect process, so that we can have user interaction IF necessary */
        document.addEventListener("DOMContentLoaded", () => {
            const dialog = document.getElementById("user-interaction-dialog");
            addButtonListeners(dialog);

            const pageUrl = new URL(window.location.href);
            let base = URL.parse(pageUrl.searchParams.get("url")) || URL.parse(pageUrl.pathname.substring(1));
            if(!!base) { // THEN if base is set, we can try the redirects
                let allMastodonProtocols;
                if(isMobile() || pageUrl.hostname === "localhost") {
                    allMastodonProtocols = ["toot:", "ivory://acct/openURL?url=https://", "metatext:", "tusker:", "fedilab:", "thedesk:", "web+mastodon:", "https:"];
                } else {
                    allMastodonProtocols = ["https://"];
                }
                const dialog_text = document.getElementById("progress-text");
                applyFormats(base, dialog, dialog_text, allMastodonProtocols);
            }
        });
    </script>
</head>

<!-- UI placeholder page below this line, in case the user did not supply a URL -->
<body>
<noscript>
    <h1>We need javascript for this.</h1>
    <p>
        We're going to try a lot of URLs in sequence, so we do need client-side scripting. You can take a look,
        it's at <a href="https://github.com/freeone3000/mmth.ca">https://github.com/freeone3000/mmth.ca</a> on GitHub,
        or right-click view source. It's not obfuscated, I don't want your data, I just need to run some interactivity.
    </p>
</noscript>

<h1>Please enter a URL below to handle the redirect.</h1>
<div id="form">
    <form method="get" target="_self" autocomplete="off">
        <label for="url">Enter a Mastodon URL to redirect to:</label><br>
        <input type="url" id="url" name="url" value="" inputmode="url" pattern="https?://.+" required autofocus placeholder="https://mastodon.social/@wonderofscience/114571068685438086"><br>
        <button type="submit">Redirect</button>
    </form>
</div>

<!-- Used for user interaction checks, which works for a "security" thing in Chrome -->
<dialog id="user-interaction-dialog" closedby="any">
    <form method="dialog">
        <p id="progress-text">Redirecting to the Mastodon app...</p>
        <button value="cancel" class="dialog-close-button" type="submit">Just use HTTPS</button>
        <button value="continue" class="dialog-close-button" type="submit" autofocus>Continue</button>
    </form>
</dialog>
</body>
</html>